{% extends "base.html" %}
{% set show_nav = true %}
{% set active_tab = 'picks' %}

{% block title %}Make Your Picks — {{ tournament_name }}{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<style>
    /* ─── Choices.js: full theme override ──────────────────────────────────────
       Strategy: target every Choices class at sufficient specificity so we don't
       need !important on most rules. The few exceptions are properties the library
       sets via JS inline styles or its own stylesheet with !important. */

    /* Wrapper — reset the library's default margin */
    .choices {
        margin-bottom: 0;
        font-family: inherit;
        font-size: 0.9375rem; /* 15px */
    }

    /* The visible "input box" area */
    .choices__inner {
        background-color: #1f2d22 !important; /* deep turf, darker than card */
        border: 1px solid #2d4a34 !important;
        border-radius: 0.5rem !important;
        padding: 0.625rem 0.75rem !important;
        min-height: 2.75rem !important;
        transition: border-color 0.15s, box-shadow 0.15s;
        cursor: pointer;
    }

    .choices.is-focused .choices__inner,
    .choices.is-open .choices__inner {
        border-color: #16a34a !important;
        box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.15) !important;
        outline: none !important;
    }

    /* Search input inside the inner box */
    .choices__input {
        background-color: transparent !important;
        color: #f9fafb !important;
        font-family: inherit;
        font-size: 0.875rem;
        padding: 0 !important;
        margin-bottom: 0 !important;
        border: none;
    }

    .choices__input::placeholder {
        color: #6b7280;
    }

    /* Selected item chips (multi-select) */
    .choices__list--multiple .choices__item {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        background-color: #15803d !important;
        border: 1px solid #166534 !important;
        color: #d1fae5 !important;
        border-radius: 0.375rem !important;
        padding: 0.25rem 0.5rem 0.25rem 0.625rem !important;
        font-size: 0.8125rem !important;
        font-weight: 500;
        letter-spacing: 0.01em;
        margin: 0.1875rem 0.25rem 0.1875rem 0 !important;
    }

    /* Remove button on chips */
    .choices__button {
        background-image: none !important;
        border-left: 1px solid rgba(255, 255, 255, 0.2) !important;
        color: #86efac !important;
        opacity: 0.7;
        width: 1rem;
        height: 1rem;
        padding: 0 !important;
        margin-left: 0.25rem !important;
        font-size: 0;                /* hide "x" text, use pseudo */
        position: relative;
    }

    .choices__button::before {
        content: "×";
        font-size: 1rem;
        line-height: 1;
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .choices__button:hover {
        opacity: 1 !important;
        color: white !important;
    }

    /* Dropdown panel */
    .choices__list--dropdown,
    .choices__list[aria-expanded] {
        background-color: #1a2e1f !important;
        border: 1px solid #2d4a34 !important;
        border-radius: 0.5rem !important;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(22, 163, 74, 0.08) !important;
        margin-top: 0.25rem !important;
        overflow: hidden !important;
        z-index: 30 !important;
    }

    /* Dropdown search box */
    .choices__list--dropdown .choices__input {
        background-color: #0f2517 !important;
        border-bottom: 1px solid #2d4a34 !important;
        padding: 0.625rem 0.75rem !important;
        font-size: 0.875rem !important;
    }

    /* Individual dropdown options */
    .choices__list--dropdown .choices__item {
        padding: 0.5rem 0.875rem !important;
        font-size: 0.875rem !important;
        color: #d1d5db !important;
        border-bottom: 1px solid #1f2d22;
        transition: background-color 0.1s, color 0.1s;
        cursor: pointer;
    }

    .choices__list--dropdown .choices__item:last-child {
        border-bottom: none;
    }

    /* Rank badge inside option text — styled via JS data attribute */
    .choices__list--dropdown .choices__item--selectable.is-highlighted {
        background-color: #166534 !important;
        color: #f0fdf4 !important;
    }

    /* Disabled / already selected items */
    .choices__list--dropdown .choices__item--disabled {
        color: #4b5563 !important;
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* "No results" / "No choices" messages */
    .choices__list--dropdown .choices__notice {
        color: #6b7280 !important;
        font-style: italic;
        padding: 0.75rem !important;
        font-size: 0.8125rem !important;
    }

    /* Ensure dropdown starts closed */
    .choices[data-type*=select-multiple] .choices__list--dropdown {
        display: none;
    }
    .choices.is-open .choices__list--dropdown {
        display: block;
    }

    /* ─── Tier accent bars ─────────────────────────────────────────────────── */
    .pick-tier {
        position: relative;
        padding-left: 1rem;
    }
    .pick-tier::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        border-radius: 2px;
    }
    .pick-tier--gold::before   { background: linear-gradient(to bottom, #fbbf24, #f59e0b); }
    .pick-tier--green::before  { background: linear-gradient(to bottom, #22c55e, #16a34a); }
    .pick-tier--muted::before  { background: linear-gradient(to bottom, #4ade80, #166534); }

    /* ─── Counter badge ────────────────────────────────────────────────────── */
    .pick-counter {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 1.5rem;
        height: 1.375rem;
        padding: 0 0.375rem;
        border-radius: 0.25rem;
        font-size: 0.6875rem;
        font-weight: 600;
        letter-spacing: 0.03em;
        transition: background-color 0.2s, color 0.2s;
    }
    .pick-counter--empty  { background: #374151; color: #6b7280; }
    .pick-counter--partial{ background: #7c3aed33; color: #a78bfa; }
    .pick-counter--full   { background: #15803d; color: #bbf7d0; }

    /* ─── Single-select Choices.js overrides ─────────────────────────────── */
    .choices[data-type*=select-one] .choices__inner {
        padding-right: 2.5rem !important;
    }

    .choices[data-type*=select-one]::after {
        /* Custom chevron icon — replaces Choices.js default arrow */
        content: "" !important;
        position: absolute !important;
        right: 0.875rem !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        width: 1.25rem !important;
        height: 1.25rem !important;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E") !important;
        background-repeat: no-repeat !important;
        background-size: contain !important;
        border: none !important;
        margin: 0 !important;
        pointer-events: none;
    }

    .choices[data-type*=select-one] .choices__list--single .choices__item {
        color: #f9fafb !important;
        font-size: 0.9375rem;
    }

    .choices[data-type*=select-one] .choices__placeholder {
        color: #6b7280 !important;
        opacity: 1 !important;
    }

    /* Hide the placeholder from the dropdown options list */
    .choices[data-type*=select-one] .choices__list--dropdown .choices__placeholder,
    .choices[data-type*=select-one] .choices__list--dropdown .choices__item[data-value=""] {
        display: none;
    }

    /* Ensure single-select dropdown starts closed too */
    .choices[data-type*=select-one] .choices__list--dropdown {
        display: none;
    }
    .choices[data-type*=select-one].is-open .choices__list--dropdown {
        display: block;
    }

    /* ─── Submit button pulse on ready ────────────────────────────────────── */
    @keyframes subtle-glow {
        0%, 100% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); }
        50%       { box-shadow: 0 0 0 6px rgba(22, 163, 74, 0.12); }
    }
    .btn-submit-ready {
        animation: subtle-glow 2.5s ease-in-out infinite;
    }
</style>
{% endblock %}

{% block main_class %}max-w-2xl mx-auto px-4 py-8{% endblock %}

{% block content %}

{# ── State: Picks Locked ──────────────────────────────────────────────────── #}
{% if picks_locked %}
<div class="card-glow bg-gray-800/80 rounded-2xl border border-red-900/50 overflow-hidden">
    <div class="px-8 py-14 text-center">
        <div class="w-16 h-16 mx-auto mb-5 bg-red-950/60 border border-red-800/60 rounded-full flex items-center justify-center">
            <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
            </svg>
        </div>
        <h2 class="font-display text-2xl text-white mb-3">Picks Are Locked</h2>
        <p class="text-gray-400 mb-8 max-w-xs mx-auto">The tournament has started. No further picks can be submitted.</p>
        <a href="/" class="inline-flex items-center gap-2 px-6 py-2.5 bg-golf-green-600 hover:bg-golf-green-700 text-white font-semibold rounded-lg transition-colors">
            View Leaderboard
        </a>
    </div>
</div>

{# ── State: Already Submitted ─────────────────────────────────────────────── #}
{% elif already_submitted %}
<div class="card-glow bg-gray-800/80 rounded-2xl border border-golf-gold-500/30 overflow-hidden">
    <div class="px-8 py-14 text-center">
        <div class="w-16 h-16 mx-auto mb-5 bg-golf-gold-500/10 border border-golf-gold-500/40 rounded-full flex items-center justify-center">
            <svg class="w-8 h-8 text-golf-gold-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
        </div>
        <h2 class="font-display text-2xl text-white mb-3">You're In</h2>
        <p class="text-gray-400 mb-1">Picks locked for this tournament.</p>
        <p class="text-golf-gold-400 font-medium text-sm mb-8">{{ existing_entry }}</p>
        <a href="/" class="inline-flex items-center gap-2 px-6 py-2.5 bg-golf-green-600 hover:bg-golf-green-700 text-white font-semibold rounded-lg transition-colors">
            View Leaderboard
        </a>
    </div>
</div>

{# ── State: No Golfer Data ─────────────────────────────────────────────────── #}
{% elif not first %}
<div class="card-glow bg-gray-800/80 rounded-2xl border border-gray-700/50 overflow-hidden">
    <div class="px-8 py-14 text-center">
        <div class="w-16 h-16 mx-auto mb-5 bg-gray-700/50 rounded-full flex items-center justify-center">
            <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
        </div>
        <h2 class="font-display text-2xl text-white mb-3">No Tournament Data Yet</h2>
        <p class="text-gray-400 mb-8 max-w-xs mx-auto">Golfer field data isn't available yet. Check back closer to tee time.</p>
        <a href="/" class="inline-flex items-center gap-2 px-6 py-2.5 bg-golf-green-600 hover:bg-golf-green-700 text-white font-semibold rounded-lg transition-colors">
            Back to Leaderboard
        </a>
    </div>
</div>

{# ── State: Active Pick Form ───────────────────────────────────────────────── #}
{% else %}

{# Page header — outside the card, sets context #}
<div class="mb-6">
    <p class="text-xs font-medium text-golf-green-500 uppercase tracking-widest mb-1">{{ tournament_name }}</p>
    <h1 class="font-display text-2xl text-white">Make Your Picks</h1>
</div>

{# One-time warning — left-bordered callout, not a banner #}
<div class="flex gap-3 items-start mb-6 px-4 py-3 rounded-lg border-l-2 border-golf-gold-500 bg-golf-gold-500/5">
    <svg class="w-4 h-4 text-golf-gold-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
    </svg>
    <p class="text-sm text-golf-gold-300 leading-snug">
        You can only submit once — picks are locked immediately and cannot be changed.
    </p>
</div>

{# Form card #}
<div class="card-glow bg-gray-800/80 rounded-2xl border border-gray-700/50 overflow-visible">
    <form action="/submit_picks" method="post" id="picks-form" novalidate>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="divide-y divide-gray-700/50">

            {# ── Field 1: Entry Name ─────────────────────────────────────────── #}
            <div class="px-6 py-6">
                <label for="entry_name" class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">
                    Entry Name
                </label>
                <input
                    id="entry_name"
                    type="text"
                    name="entry_name"
                    class="w-full px-3.5 py-2.5 bg-gray-900/60 border border-gray-600/60 rounded-lg text-gray-100 placeholder-gray-500 text-[0.9375rem] focus:border-golf-green-500 focus:ring-2 focus:ring-golf-green-500/15 focus:outline-none transition-colors"
                    placeholder="Give your team a name..."
                    autocomplete="off"
                    required>
                <p class="mt-2 text-xs text-gray-500">This appears on the leaderboard — make it good.</p>
            </div>

            {# ── Field 2: Top 5 Pick ─────────────────────────────────────────── #}
            <div class="px-6 py-6">
                <div class="pick-tier pick-tier--gold">
                    <div class="flex items-baseline justify-between mb-3">
                        <label for="golfer_1" class="text-xs font-semibold text-gray-400 uppercase tracking-wider">
                            Top 5 Pick
                        </label>
                        <span class="text-xs text-golf-gold-500/70 font-medium">Pick 1</span>
                    </div>
                    <select
                        id="golfer_1"
                        name="golfer_1"
                        class="choices-single w-full"
                        required>
                        <option value="" placeholder>Select a golfer...</option>
                        {% for golfer in first %}
                        <option value="{{ golfer.name }}">{{ golfer.name }}</option>
                        {% endfor %}
                    </select>
                    <p class="mt-2 text-xs text-gray-500">Top-tier golfers</p>
                </div>
            </div>

            {# ── Field 3: 6–16 Picks ─────────────────────────────────────────── #}
            <div class="px-6 py-6">
                <div class="pick-tier pick-tier--green">
                    <div class="flex items-center justify-between mb-3">
                        <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">
                            Mid-Field Picks
                        </label>
                        <span id="counter-mid" class="pick-counter pick-counter--empty">0 / 2</span>
                    </div>
                    <select name="golfer_2_and_3" id="select-mid" class="choices-multiple w-full" multiple>
                        {% for golfer in second %}
                        <option value="{{ golfer.name }}">{{ golfer.name }}</option>
                        {% endfor %}
                    </select>
                    <p class="mt-2 text-xs text-gray-500">Mid-tier golfers — choose exactly 2</p>
                </div>
            </div>

            {# ── Field 4: 17+ Picks ──────────────────────────────────────────── #}
            <div class="px-6 py-6">
                <div class="pick-tier pick-tier--muted">
                    <div class="flex items-center justify-between mb-3">
                        <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">
                            Long Shot Picks
                        </label>
                        <span id="counter-long" class="pick-counter pick-counter--empty">0 / 2</span>
                    </div>
                    <select name="golfer_4_and_5" id="select-long" class="choices-multiple w-full" multiple>
                        {% for golfer in third %}
                        <option value="{{ golfer.name }}">{{ golfer.name }}</option>
                        {% endfor %}
                    </select>
                    <p class="mt-2 text-xs text-gray-500">Lower-tier golfers — choose exactly 2</p>
                </div>
            </div>

            {# ── Submit Area ─────────────────────────────────────────────────── #}
            <div class="px-6 py-5 flex flex-col-reverse sm:flex-row sm:items-center sm:justify-between gap-4">
                <a href="/" class="text-sm text-gray-500 hover:text-gray-300 transition-colors text-center sm:text-left">
                    &larr; Back
                </a>
                <button
                    id="submit-btn"
                    type="submit"
                    class="flex items-center justify-center gap-2 w-full sm:w-auto px-8 py-2.5 bg-golf-green-600 hover:bg-golf-green-700 active:bg-golf-green-800 text-white font-semibold rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-golf-green-500/50 shadow-lg shadow-golf-green-900/30">
                    <span id="submit-label">Submit Picks</span>
                    <svg id="submit-spinner" class="hidden w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                    </svg>
                </button>
            </div>

        </div>{# /divide-y #}
    </form>
</div>{# /card #}

{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // ── Choices.js init ────────────────────────────────────────────────────────
    const choicesConfig = {
        removeItemButton: true,
        maxItemCount: 2,
        searchEnabled: true,
        placeholder: true,
        placeholderValue: 'Search and select golfers...',
        noResultsText: 'No golfers found',
        noChoicesText: 'No more options',
        itemSelectText: '',   // suppress the "Press to select" hint
        classNames: {
            containerOuter: 'choices',
            containerInner: 'choices__inner',
            input: 'choices__input',
            inputCloned: 'choices__input--cloned',
            list: 'choices__list',
            listItems: 'choices__list--multiple',
            listSingle: 'choices__list--single',
            listDropdown: 'choices__list--dropdown',
            item: 'choices__item',
            itemSelectable: 'choices__item--selectable',
            itemDisabled: 'choices__item--disabled',
            itemChoice: 'choices__item--choice',
            notice: 'choices__notice',
            group: 'choices__group',
            groupHeading: 'choices__heading',
            button: 'choices__button',
        },
    };

    // Single-select for Top 5
    const topSelect = document.getElementById('golfer_1');
    if (topSelect) {
        new Choices(topSelect, {
            searchEnabled: true,
            placeholder: true,
            placeholderValue: 'Select a golfer...',
            noResultsText: 'No golfers found',
            itemSelectText: '',
            shouldSort: false,
            searchPlaceholderValue: 'Search golfers...',
            allowHTML: false,
        });
    }

    // Multi-selects for 6-16 and 17+
    const midSelect  = document.getElementById('select-mid');
    const longSelect = document.getElementById('select-long');

    const midChoices  = midSelect  ? new Choices(midSelect,  choicesConfig) : null;
    const longChoices = longSelect ? new Choices(longSelect, choicesConfig) : null;

    // ── Live pick counters ─────────────────────────────────────────────────────
    function updateCounter(counterId, count, max) {
        const el = document.getElementById(counterId);
        if (!el) return;
        el.textContent = `${count} / ${max}`;
        el.className = 'pick-counter ' + (
            count === 0         ? 'pick-counter--empty'   :
            count < max         ? 'pick-counter--partial' :
            /* count === max */   'pick-counter--full'
        );
    }

    function getChoicesCount(selectEl) {
        if (!selectEl) return 0;
        return Array.from(selectEl.options).filter(o => o.selected).length;
    }

    function refreshCounters() {
        updateCounter('counter-mid',  getChoicesCount(midSelect),  2);
        updateCounter('counter-long', getChoicesCount(longSelect), 2);
    }

    // Choices.js fires native change events on the underlying <select>
    if (midSelect)  midSelect.addEventListener('change',  refreshCounters);
    if (longSelect) longSelect.addEventListener('change', refreshCounters);

    // ── Confirmation + double-submit guard ────────────────────────────────────
    const form      = document.getElementById('picks-form');
    const submitBtn = document.getElementById('submit-btn');
    const submitLabel   = document.getElementById('submit-label');
    const submitSpinner = document.getElementById('submit-spinner');
    let submitting = false;

    if (form) {
        form.addEventListener('submit', function (e) {
            if (submitting) { e.preventDefault(); return; }
            e.preventDefault();

            // Gather values for validation and confirmation
            const entryName = form.querySelector('#entry_name')?.value?.trim() ?? '';
            const golfer1El = form.querySelector('#golfer_1');
            const g1Text    = golfer1El?.options[golfer1El.selectedIndex]?.text ?? '';

            const midPicks  = midSelect  ? Array.from(midSelect.options).filter(o => o.selected).map(o => o.text)  : [];
            const longPicks = longSelect ? Array.from(longSelect.options).filter(o => o.selected).map(o => o.text) : [];

            // Client-side validation with clear messages
            if (!entryName) {
                alert('Please enter a team name before submitting.');
                form.querySelector('#entry_name')?.focus();
                return;
            }
            if (!g1Text || golfer1El?.value === '') {
                alert('Please select your Top 5 pick.');
                golfer1El?.focus();
                return;
            }
            if (midPicks.length !== 2) {
                alert(`Please select exactly 2 Mid-Field picks (you have ${midPicks.length}).`);
                return;
            }
            if (longPicks.length !== 2) {
                alert(`Please select exactly 2 Long Shot picks (you have ${longPicks.length}).`);
                return;
            }

            const allPicks = [g1Text, ...midPicks, ...longPicks];
            const pickLines = allPicks.map((p, i) => `  ${i + 1}. ${p}`).join('\n');

            const confirmed = confirm(
                `Confirm picks for "${entryName}"?\n\n` +
                pickLines +
                '\n\nThese cannot be changed after submission.'
            );

            if (!confirmed) return;

            // Lock the UI and submit
            submitting = true;
            submitBtn.disabled = true;
            submitBtn.classList.remove('hover:bg-golf-green-700');
            submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
            submitLabel.textContent = 'Submitting...';
            submitSpinner.classList.remove('hidden');

            form.submit();
        });
    }
});
</script>
{% endblock %}
