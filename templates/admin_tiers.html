{% extends "base.html" %}
{% set show_nav = true %}
{% set active_tab = 'admin' %}

{% block title %}Manage Tiers - {{ tournament_name }}{% endblock %}

{% block main_class %}max-w-4xl mx-auto px-4 py-8{% endblock %}

{% block content %}
        <!-- Header -->
        <div class="mb-6">
            <a href="/admin" class="text-sm text-gray-400 hover:text-white transition-colors">&larr; Back to Admin</a>
            <h1 class="font-display text-2xl text-white mt-2">Manage Tiers</h1>
            <p class="text-sm text-gray-400 mt-1">{{ tournament_name }}</p>
        </div>

        <!-- Stats Bar -->
        <div class="mb-6 flex items-center space-x-4 text-sm">
            <span class="text-gray-400">{{ golfer_count }} golfers</span>
            {% if override_count > 0 %}
            <span class="px-2 py-0.5 bg-purple-600/30 text-purple-300 rounded text-xs">{{ override_count }} override{{ 's' if override_count != 1 }}</span>
            {% endif %}
            <div class="flex-1"></div>
            <form action="/admin/fetch-dk-salaries" method="POST" class="inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="tournament_id" value="{{ tournament_id }}">
                <button type="submit" class="px-3 py-1.5 text-xs bg-transparent border border-green-700 text-green-400 hover:border-green-500 hover:text-green-300 rounded transition-colors">
                    Fetch DK Salaries
                </button>
            </form>
            <form action="/admin/reset-tiers" method="POST" class="inline" onsubmit="return confirm('Reset all tier overrides to auto-computed values?')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="tournament_id" value="{{ tournament_id }}">
                <button type="submit" class="px-3 py-1.5 text-xs bg-transparent border border-gray-600 text-gray-400 hover:border-red-500 hover:text-red-400 rounded transition-colors">
                    Reset All Overrides
                </button>
            </form>
        </div>

        <!-- Tier Management Form -->
        <form action="/admin/save-tiers" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="tournament_id" value="{{ tournament_id }}">

            {% if has_dk_data %}
            {% set tiers = [
                ('Tier 1', 'Top 5 by DK salary', tier_1, 'green'),
                ('Tier 2', 'Ranked 6-16 by DK salary', tier_2, 'blue'),
                ('Tier 3', 'Ranked 17+ by DK salary', tier_3, 'gray')
            ] %}
            {% else %}
            {% set tiers = [
                ('Tier 1', 'Top 5 by OWGR', tier_1, 'green'),
                ('Tier 2', 'Ranked 6-16 by OWGR', tier_2, 'blue'),
                ('Tier 3', 'Ranked 17+ by OWGR', tier_3, 'gray')
            ] %}
            {% endif %}

            {% for tier_name, tier_desc, tier_golfers, color in tiers %}
            <div class="mb-6">
                <div class="flex items-center space-x-3 mb-3">
                    <h2 class="text-lg font-semibold text-white">{{ tier_name }}</h2>
                    <span class="text-xs text-gray-500">{{ tier_desc }}</span>
                    <span class="px-2 py-0.5 text-xs bg-{{ color }}-600/20 text-{{ color }}-400 rounded">{{ tier_golfers|length }}</span>
                </div>

                {% if tier_golfers %}
                <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-700/50">
                            <tr>
                                <th class="px-4 py-2 text-left font-medium text-gray-300 w-10">#</th>
                                <th class="px-4 py-2 text-left font-medium text-gray-300">Golfer</th>
                                <th class="px-4 py-2 text-left font-medium text-gray-300 w-24">{% if has_dk_data %}DK Salary{% else %}OWGR{% endif %}</th>
                                <th class="px-4 py-2 text-right font-medium text-gray-300 w-40">Tier</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            {% for g in tier_golfers %}
                            <tr class="{% if g.is_overridden %}bg-purple-900/20{% else %}hover:bg-gray-700/30{% endif %}">
                                <td class="px-4 py-2 text-gray-500">{{ loop.index }}</td>
                                <td class="px-4 py-2 font-medium text-white">
                                    {{ g.name }}
                                    {% if g.is_overridden %}
                                    <span class="ml-2 px-1.5 py-0.5 text-[10px] bg-purple-600/40 text-purple-300 rounded">moved</span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-2 text-gray-400">{% if has_dk_data %}{{ '${:,}'.format(g.dk_salary) if g.dk_salary else '—' }}{% else %}{{ g.owgr_rank or '—' }}{% endif %}</td>
                                <td class="px-4 py-2 text-right">
                                    <select name="tier_{{ g.id }}"
                                        class="px-2 py-1 text-xs bg-gray-700 border border-gray-600 rounded text-white focus:outline-none focus:border-purple-500">
                                        <option value="auto" {% if not g.is_overridden %}selected{% endif %}>
                                            Auto (T{{ g.computed_tier }})
                                        </option>
                                        <option value="1" {% if g.tier_override == 1 %}selected{% endif %}>Tier 1</option>
                                        <option value="2" {% if g.tier_override == 2 %}selected{% endif %}>Tier 2</option>
                                        <option value="3" {% if g.tier_override == 3 %}selected{% endif %}>Tier 3</option>
                                    </select>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 text-center">
                    <p class="text-gray-500 text-sm">No golfers in this tier</p>
                </div>
                {% endif %}
            </div>
            {% endfor %}

            <!-- Sticky Save Bar -->
            <div class="sticky bottom-0 bg-gray-900/95 border-t border-gray-700 -mx-4 px-4 py-3 mt-8 backdrop-blur">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-400">Changes are not saved until you click Save</span>
                    <button type="submit" class="px-6 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded font-medium text-sm transition-colors">
                        Save Tier Assignments
                    </button>
                </div>
            </div>
        </form>
{% endblock %}
